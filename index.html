// 調酒master主腳本（整合Firebase與前端功能）

// 初始化 Firebase（確保你的 firebaseConfig 正確設定）
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();
let currentUser = null;
let cocktailData = [];

firebase.auth().onAuthStateChanged((user) => {
  currentUser = user;
  if (user) {
    document.getElementById('user-info').textContent = user.displayName || user.email;
    loadUserCocktails();
  } else {
    document.getElementById('user-info').textContent = '未登入';
  }
});

// 儲存自訂調酒
async function saveCustomCocktail() {
  if (!currentUser) return alert('請先登入才能儲存調酒！');

  const cocktail = {
    name: document.getElementById('cocktail-name').value.trim(),
    ingredients: document.getElementById('ingredients').value.trim(),
    instructions: document.getElementById('instructions').value.trim(),
    alcohol: parseFloat(document.getElementById('alcohol').value),
    price: parseInt(document.getElementById('price').value),
    isPublic: document.getElementById('is-public').checked,
    votes: 0,
    createdAt: firebase.firestore.FieldValue.serverTimestamp()
  };

  try {
    const userRef = db.collection('users').doc(currentUser.uid);
    const userCocktailRef = await userRef.collection('cocktails').add(cocktail);

    if (cocktail.isPublic) {
      await db.collection('publicCocktails').doc(userCocktailRef.id).set({
        ...cocktail,
        owner: currentUser.uid
      });
    }

    cocktailData.push(cocktail);
    addToCustomList(cocktail);
    alert('調酒儲存成功！');
  } catch (e) {
    console.error(e);
    alert('儲存調酒失敗');
  }
}

// 讀取使用者的自訂調酒（含公開與否）
async function loadUserCocktails() {
  if (!currentUser) return;
  const snapshot = await db.collection('users')
    .doc(currentUser.uid)
    .collection('cocktails')
    .orderBy('createdAt', 'asc')
    .get();

  cocktailData = [];
  snapshot.forEach(doc => {
    const data = doc.data();
    cocktailData.push(data);
    addToCustomList(data);
  });
}

// 即時監聽排行榜
function listenToRanking() {
  db.collection('publicCocktails').orderBy('votes', 'desc')
    .onSnapshot(snapshot => {
      const ranking = [];
      snapshot.forEach(doc => ranking.push({ id: doc.id, ...doc.data() }));
      updateRanking(ranking);
    });
}

// 投票
async function vote(cocktailId) {
  if (!currentUser) return alert('請先登入才能投票');

  const voteDocId = `${currentUser.uid}_${cocktailId}`;
  const voteRef = db.collection('votes').doc(voteDocId);
  const cocktailRef = db.collection('publicCocktails').doc(cocktailId);

  const voteDoc = await voteRef.get();
  if (voteDoc.exists) return alert('你已投票過了');

  await db.runTransaction(async (tx) => {
    tx.set(voteRef, { user: currentUser.uid, cocktail: cocktailId });
    const cocktailDoc = await tx.get(cocktailRef);
    const votes = (cocktailDoc.data().votes || 0) + 1;
    tx.update(cocktailRef, { votes });
  });

  alert('投票成功');
}

// 搜尋推薦
async function searchCocktailsByCriteria(maxPrice, maxAlcohol) {
  const snapshot = await db.collection('publicCocktails').get();
  const filtered = [];
  snapshot.forEach(doc => {
    const data = doc.data();
    if (data.price <= maxPrice && data.alcohol <= maxAlcohol) filtered.push(data);
  });
  updateSearchResults(filtered);
}

// UI 更新函式
function addToCustomList(cocktail) {
  const list = document.getElementById('custom-list');
  const li = document.createElement('li');
  li.textContent = `${cocktail.name} (${cocktail.isPublic ? '公開' : '私密'})`;
  list.appendChild(li);
}

function updateRanking(cocktails) {
  const list = document.getElementById('ranking-list');
  list.innerHTML = '';
  cocktails.forEach(c => {
    const li = document.createElement('li');
    li.textContent = `${c.name} - ${c.votes} 票`;
    li.addEventListener('click', () => showCocktailDetail(c));
    list.appendChild(li);
  });
}

function updateSearchResults(results) {
  const list = document.getElementById('search-results');
  list.innerHTML = '';
  results.forEach(c => {
    const li = document.createElement('li');
    li.textContent = `${c.name} - ${c.alcohol}% - $${c.price}`;
    list.appendChild(li);
  });
}

function showCocktailDetail(cocktail) {
  alert(`名稱: ${cocktail.name}\n材料: ${cocktail.ingredients}\n做法: ${cocktail.instructions}\n酒精: ${cocktail.alcohol}%\n價格: $${cocktail.price}`);
}

// 初始監聽啟動
listenToRanking();
