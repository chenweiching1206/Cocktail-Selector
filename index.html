<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <title>調酒網站</title>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
  <style>
    #logout-btn, #user-avatar {
      display: none;
    }
  </style>
</head>
<body>
  <h1>調酒網站</h1>
  <button id="login-btn">Google 登入</button>
  <button id="logout-btn">登出</button>
  <img id="user-avatar" width="30" height="30" />

  <div>
    <input type="text" id="cocktail-name" placeholder="酒名" />
    <textarea id="cocktail-recipe" placeholder="酒譜內容"></textarea>
    <input type="number" id="cocktail-abv" placeholder="酒精濃度 %" />
    <label><input type="checkbox" id="public-checkbox">公開酒譜</label>
    <button onclick="saveCocktail()">儲存酒譜</button>
  </div>

  <h2>排行榜</h2>
  <ul id="ranking-list"></ul>

  <script>
    // Firebase 初始化
    const firebaseConfig = {
      apiKey: "你的API金鑰",
      authDomain: "你的authDomain",
      projectId: "你的projectId",
      storageBucket: "你的storageBucket",
      messagingSenderId: "你的messagingSenderId",
      appId: "你的appId"
    };
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();

    let currentUser = null;

    // 登入/登出邏輯
    document.getElementById('login-btn').addEventListener('click', () => {
      const provider = new firebase.auth.GoogleAuthProvider();
      auth.signInWithPopup(provider);
    });

    document.getElementById('logout-btn').addEventListener('click', () => {
      auth.signOut();
    });

    auth.onAuthStateChanged(user => {
      if (user) {
        currentUser = user;
        document.getElementById('user-avatar').src = user.photoURL;
        document.getElementById('user-avatar').style.display = 'inline';
        document.getElementById('login-btn').style.display = 'none';
        document.getElementById('logout-btn').style.display = 'inline';
        listenToRanking(); // 即時更新排行榜
      } else {
        currentUser = null;
        document.getElementById('user-avatar').style.display = 'none';
        document.getElementById('login-btn').style.display = 'inline';
        document.getElementById('logout-btn').style.display = 'none';
        listenToRanking(); // 未登入也可查看排行榜
      }
    });

    // 儲存酒譜
    async function saveCocktail() {
      const name = document.getElementById('cocktail-name').value.trim();
      const recipe = document.getElementById('cocktail-recipe').value.trim();
      const abv = parseFloat(document.getElementById('cocktail-abv').value);
      const isPublic = document.getElementById('public-checkbox').checked;

      if (!currentUser) {
        alert("請先登入才能儲存");
        return;
      }
      if (!name || !recipe || isNaN(abv)) {
        alert("請輸入完整資料");
        return;
      }

      const cocktailData = {
        name,
        recipe,
        abv,
        userId: currentUser.uid,
        userName: currentUser.displayName,
        userAvatar: currentUser.photoURL,
        timestamp: firebase.firestore.FieldValue.serverTimestamp()
      };

      try {
        const docRef = await db.collection('userCocktails').add(cocktailData);

        if (isPublic) {
          await db.collection('publicCocktails').doc(docRef.id).set({
            ...cocktailData,
            votes: 0,
            voters: []
          });
        }

        alert("儲存成功！");
      } catch (error) {
        console.error("儲存失敗：", error);
      }
    }

    // 監聽排行榜變化（即時）
    function listenToRanking() {
      db.collection('publicCocktails')
        .orderBy('votes', 'desc')
        .onSnapshot(snapshot => {
          const list = document.getElementById('ranking-list');
          list.innerHTML = '';
          snapshot.forEach(doc => {
            addToRanking(doc.data(), doc.id);
          });
        }, err => {
          console.error("監聽失敗：", err);
        });
    }

    // 顯示排行榜項目
    function addToRanking(cocktail, docId) {
      const list = document.getElementById('ranking-list');
      const item = document.createElement('li');
      item.innerHTML = `
        <strong>${cocktail.name}</strong> by ${cocktail.userName}
        <br>酒精濃度：${cocktail.abv}%
        <br><em>${cocktail.recipe}</em>
        <br>票數：${cocktail.votes || 0}
        <br><button onclick="vote('${docId}')">投票</button>
        <hr>
      `;
      list.appendChild(item);
    }

    // 投票功能（每人每酒只能投一次）
    async function vote(docId) {
      if (!currentUser) {
        alert("請先登入才能投票");
        return;
      }

      const docRef = db.collection('publicCocktails').doc(docId);
      const docSnap = await docRef.get();
      const data = docSnap.data();

      if (data.voters && data.voters.includes(currentUser.uid)) {
        alert("你已投過票！");
        return;
      }

      await docRef.update({
        votes: (data.votes || 0) + 1,
        voters: firebase.firestore.FieldValue.arrayUnion(currentUser.uid)
      });

      alert("投票成功！");
    }
  </script>
</body>
</html>
