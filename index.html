<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>調酒天地</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }
    body {
      background-color: #f4f1ec;
      color: #333;
    }
    header {
      background-color: #ffcc00;
      padding: 1rem 2rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      position: relative;
      z-index: 10;
    }
    #logo {
      font-size: 1.8rem;
      font-weight: bold;
    }
    #user-info {
      display: flex;
      align-items: center;
      gap: 1rem;
    }
    #login-btn, #logout-btn {
      padding: 0.6rem 1.2rem;
      background-color: #333;
      color: white;
      border: none;
      border-radius: 5px;
      cursor: pointer;
    }
    #user-avatar {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      display: none;
    }
    .beer-bg {
      position: relative;
      height: 300px;
      background: linear-gradient(to top, #f7d774, #fff3b0);
      overflow: hidden;
      z-index: 1;
    }
    .bubble {
      position: absolute;
      bottom: 0;
      background-color: white;
      border-radius: 50%;
      opacity: 0.7;
      animation: rise 5s infinite ease-in;
      pointer-events: none;
    }
    @keyframes rise {
      0% { transform: translateY(0); opacity: 0.7; }
      100% { transform: translateY(-300px); opacity: 0; }
    }
    nav {
      display: flex;
      justify-content: center;
      background-color: #fff9d6;
      box-shadow: inset 0 -1px 0 #e0dcbf;
      position: relative;
      z-index: 10;
    }
    nav button {
      flex: 1;
      padding: 1rem;
      border: none;
      background: none;
      font-size: 1rem;
      cursor: pointer;
      transition: background-color 0.3s;
    }
    nav button:hover {
      background-color: #ffe577;
    }
    .section {
      display: none;
      padding: 2rem;
      max-width: 800px;
      margin: auto;
      position: relative;
      z-index: 10;
    }
    .active {
      display: block;
    }
    form {
      display: flex;
      flex-direction: column;
      gap: 1rem;
    }
    label {
      display: flex;
      flex-direction: column;
      font-weight: bold;
    }
    input, select, textarea, button[type="submit"], input[type="range"] {
      padding: 0.5rem;
      font-size: 1rem;
      border-radius: 5px;
      border: 1px solid #ccc;
    }
    button[type="submit"] {
      background-color: #ffcc00;
      border: none;
      cursor: pointer;
      font-weight: bold;
    }
    ul li {
      list-style: none;
      margin-bottom: 1rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
      cursor: pointer;
    }
    ul li span {
      margin-left: 1rem;
    }
    /* 顯示價錢估計的文字 */
    #price-value {
      font-weight: bold;
      margin-left: 10px;
      color: #666;
    }
    /* 調酒名稱可點擊樣式 */
    #custom-cocktails li:hover {
      text-decoration: underline;
      color: #ff8c00;
    }
    /* 彈出酒譜細節的簡易樣式 */
    #cocktail-detail {
      margin-top: 1rem;
      padding: 1rem;
      border: 1px solid #ccc;
      border-radius: 6px;
      background-color: #fffbea;
      max-width: 800px;
      margin-left: auto;
      margin-right: auto;
      white-space: pre-line;
    }
  </style>
  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js"></script>
</head>
<body>
  <header>
    <div id="logo">調酒天地</div>
    <div id="user-info">
      <img id="user-avatar" src="" alt="頭像" />
      <button id="login-btn">登入</button>
      <button id="logout-btn" style="display:none;">登出</button>
    </div>
  </header>

  <div id="beer-bg" class="beer-bg"></div>

  <nav>
    <button onclick="switchPage('page1')">自訂調酒</button>
    <button onclick="switchPage('page2')">搜尋推薦</button>
    <button onclick="switchPage('page3')">排行榜</button>
  </nav>

  <section id="page1" class="section active">
    <h2>自訂你的調酒</h2>
    <form id="cocktail-form">
      <label>調酒名稱 <input type="text" id="cocktail-name" required /></label>
      <label>內容物 <input type="text" id="cocktail-ingredients" required /></label>
      <label>比例（例如 2:1:1） <input type="text" id="cocktail-ratio" /></label>
      <label>口感描述 <textarea id="cocktail-taste" rows="3"></textarea></label>
      <label>價錢估計 <input type="range" id="cocktail-price" min="100" max="1000" step="50" value="100" />
        <span id="price-value">100</span> 元
      </label>
      <label>是否公開 <input type="checkbox" id="cocktail-public" /></label>
      <button type="submit">儲存酒譜</button>
    </form>
    <h3>自訂調酒列表</h3>
    <ul id="custom-cocktails"></ul>
    <div id="cocktail-detail"></div>
  </section>

  <section id="page2" class="section">
    <h2>搜尋推薦調酒</h2>
    <form id="search-form">
      <label>預算（元） <input type="number" id="search-budget" min="100" step="50" /></label>
      <label>酒精濃度（%） <input type="number" id="search-alcohol" min="0" max="100" /></label>
      <button type="submit">搜尋推薦</button>
    </form>
    <div id="recommendation-list">搜尋結果會出現在這裡</div>
  </section>

  <section id="page3" class="section">
    <h2>調酒排行榜</h2>
    <ul id="ranking-list">
      <!-- 排行榜會動態更新 -->
    </ul>
  </section>

  <script>
    // Firebase config
    const firebaseConfig = {
      apiKey: "AIzaSyAb7IehvgRm-b2o_yJ3SkdQDWwjy7ugC6I",
      authDomain: "cocktail-selector-a1b46.firebaseapp.com",
      projectId: "cocktail-selector-a1b46",
      storageBucket: "cocktail-selector-a1b46.appspot.com",
      messagingSenderId: "213382733661",
      appId: "1:213382733661:web:3487fa9ebbb2e0c64652b4",
      measurementId: "G-LC2T6DR3HB"
    };

    // Initialize Firebase
    const app = firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();

    // DOM elements
    const loginBtn = document.getElementById('login-btn');
    const logoutBtn = document.getElementById('logout-btn');
    const userAvatar = document.getElementById('user-avatar');
    const cocktailForm = document.getElementById('cocktail-form');
    const customCocktailsUL = document.getElementById('custom-cocktails');
    const cocktailDetail = document.getElementById('cocktail-detail');
    const priceRange = document.getElementById('cocktail-price');
    const priceValue = document.getElementById('price-value');
    const rankingList = document.getElementById('ranking-list');
    const searchForm = document.getElementById('search-form');
    const recommendationList = document.getElementById('recommendation-list');

    // 更新價錢顯示
    priceRange.addEventListener('input', () => {
      priceValue.textContent = priceRange.value;
    });

    // 登入處理
    loginBtn.addEventListener('click', async () => {
      const provider = new firebase.auth.GoogleAuthProvider();
      try {
        const result = await auth.signInWithPopup(provider);
        // 登入成功，UI會透過onAuthStateChanged更新
      } catch (err) {
        alert("登入失敗：" + err.message);
      }
    });

    // 登出處理
    logoutBtn.addEventListener('click', async () => {
      try {
        await auth.signOut();
      } catch (err) {
        alert("登出失敗：" + err.message);
      }
    });

    // 切換頁面
    function switchPage(id) {
      document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
      document.getElementById(id).classList.add('active');
      // 清除細節展示和搜尋結果
      cocktailDetail.textContent = '';
      recommendationList.textContent = '搜尋結果會出現在這裡';
    }

    // 顯示使用者資料UI
    auth.onAuthStateChanged(user => {
      if (user) {
        userAvatar.src = user.photoURL || '';
        userAvatar.style.display = 'inline';
        loginBtn.style.display = 'none';
        logoutBtn.style.display = 'inline';
        loadUserCocktails(user.uid);
        loadRanking();
      } else {
        userAvatar.style.display = 'none';
        loginBtn.style.display = 'inline';
        logoutBtn.style.display = 'none';
        customCocktailsUL.innerHTML = '';
        rankingList.innerHTML = '';
        cocktailDetail.textContent = '';
        recommendationList.textContent = '請先登入才能使用搜尋推薦與自訂調酒功能';
      }
    });

    // 儲存酒譜到 Firestore
    cocktailForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      const user = auth.currentUser;
      if (!user) {
        alert('請先登入');
        return;
      }
      const name = document.getElementById('cocktail-name').value.trim();
      const ingredients = document.getElementById('cocktail-ingredients').value.trim();
      const ratio = document.getElementById('cocktail-ratio').value.trim();
      const taste = document.getElementById('cocktail-taste').value.trim();
      const price = Number(document.getElementById('cocktail-price').value);
      const isPublic = document.getElementById('cocktail-public').checked;

      if (!name || !ingredients) {
        alert('請填寫調酒名稱與內容物');
        return;
      }

      try {
        // 新增酒譜至使用者收藏（userCocktails）
        const userCocktailRef = await db.collection('userCocktails').add({
          userId: user.uid,
          name,
          ingredients,
          ratio,
          taste,
          price,
          isPublic,
          createdAt: firebase.firestore.FieldValue.serverTimestamp(),
          votes: 0 // 初始票數
        });

        // 如果公開，加入排行榜（ranking）
        if (isPublic) {
          await db.collection('ranking').doc(userCocktailRef.id).set({
            name,
            ingredients,
            ratio,
            taste,
            price,
            votes: 0,
            createdAt: firebase.firestore.FieldValue.serverTimestamp()
          });
        }

        // 表單清空
        cocktailForm.reset();
        priceValue.textContent = '100'; // 預設價格顯示
        loadUserCocktails(user.uid);
        loadRanking();
        alert('酒譜已儲存！');
      } catch (err) {
        alert('儲存失敗：' + err.message);
      }
    });

    // 載入使用者自訂調酒列表
    async function loadUserCocktails(uid) {
      customCocktailsUL.innerHTML = '';
      const querySnapshot = await db.collection('userCocktails').where('userId', '==', uid).orderBy('createdAt', 'asc').get();
      querySnapshot.forEach(doc => {
        const data = doc.data();
        const li = document.createElement('li');
        li.textContent = data.name + ` - ${data.price}元`;
        li.style.cursor = 'pointer';
        li.addEventListener('click', () => {
          showCocktailDetail(data);
        });
        customCocktailsUL.appendChild(li);
      });
    }

    // 顯示酒譜細節
    function showCocktailDetail(data) {
      cocktailDetail.textContent =
        `名稱: ${data.name}\n` +
        `內容物: ${data.ingredients}\n` +
        `比例: ${data.ratio}\n` +
        `口感描述: ${data.taste}\n` +
        `估計價錢: ${data.price} 元\n` +
        `是否公開: ${data.isPublic ? '是' : '否'}`;
    }

    // 載入排行榜資料
    async function loadRanking() {
      rankingList.innerHTML = '';
      const querySnapshot = await db.collection('ranking').orderBy('votes', 'desc').limit(20).get();
      querySnapshot.forEach(doc => {
        const data = doc.data();
        const li = document.createElement('li');
        li.textContent = `${data.name} - 票數: ${data.votes}`;
        rankingList.appendChild(li);
      });
    }

    // 搜尋推薦功能(簡單以價錢篩選排行榜)
    searchForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      const budget = Number(document.getElementById('search-budget').value);
      const alcohol = Number(document.getElementById('search-alcohol').value);

      // 篩選條件示意：目前用價錢小於等於budget
      let query = db.collection('ranking').orderBy('votes', 'desc');

      const results = [];
      const snapshot = await query.get();

      snapshot.forEach(doc => {
        const data = doc.data();
        if ((!budget || data.price <= budget)) {
          results.push(data);
        }
      });

      if (results.length === 0) {
        recommendationList.textContent = '找不到符合條件的調酒';
        return;
      }

      recommendationList.innerHTML = '';
      results.forEach(item => {
        const div = document.createElement('div');
        div.style.marginBottom = '1rem';
        div.innerHTML =
          `<strong>${item.name}</strong> <br>` +
          `內容物: ${item.ingredients} <br>` +
          `比例: ${item.ratio} <br>` +
          `價錢: ${item.price} 元 <br>` +
          `票數: ${item.votes}`;
        recommendationList.appendChild(div);
      });
    });

    // 泡泡動畫產生器
    function createBubble() {
      const bubble = document.createElement('div');
      bubble.classList.add('bubble');
      const size = Math.random() * 15 + 10 + 'px';
      bubble.style.width = size;
      bubble.style.height = size;
      bubble.style.left = Math.random() * 100 + '%';
      bubble.style.animationDuration = (Math.random() * 3 + 3) + 's';
      document.getElementById('beer-bg').appendChild(bubble);

      setTimeout(() => {
        bubble.remove();
      }, 6000);
    }
    // 每 300ms 產生一個泡泡
    setInterval(createBubble, 300);
  </script>
</body>
</html>
