<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <title>調酒master</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; }
    h2 { margin-top: 40px; }
    .cocktail-item { margin-bottom: 10px; }
    button { margin-left: 10px; }
  </style>
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.11.0/firebase-app.js";
    import { getAuth, onAuthStateChanged, signInWithPopup, GoogleAuthProvider, signOut } from "https://www.gstatic.com/firebasejs/10.11.0/firebase-auth.js";
    import { getFirestore, doc, setDoc, getDoc, getDocs, collection, query, orderBy, updateDoc, increment, onSnapshot, where } from "https://www.gstatic.com/firebasejs/10.11.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "你的API金鑰",
      authDomain: "你的專案.firebaseapp.com",
      projectId: "你的project-id",
      storageBucket: "你的project-id.appspot.com",
      messagingSenderId: "你的發送者ID",
      appId: "你的App ID"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    let currentUser = null;

    const signInBtn = document.getElementById("signIn");
    const signOutBtn = document.getElementById("signOut");
    const userInfo = document.getElementById("userInfo");

    signInBtn.onclick = async () => {
      const provider = new GoogleAuthProvider();
      await signInWithPopup(auth, provider);
    };

    signOutBtn.onclick = async () => {
      await signOut(auth);
    };

    onAuthStateChanged(auth, async user => {
      if (user) {
        currentUser = user;
        userInfo.textContent = `登入中：${user.displayName}`;
        document.getElementById("customList").innerHTML = "";
        loadCustomCocktails();
        subscribeToPublicCocktails();
      } else {
        currentUser = null;
        userInfo.textContent = "尚未登入";
        document.getElementById("customList").innerHTML = "";
        document.getElementById("rankingList").innerHTML = "";
      }
    });

    async function saveCustomCocktail() {
      const name = document.getElementById("cName").value;
      const price = Number(document.getElementById("cPrice").value);
      const alcohol = Number(document.getElementById("cAlc").value);
      const publicToggle = document.getElementById("cPublic").checked;

      const newCocktail = { name, price, alcohol, public: publicToggle };
      const userRef = doc(db, "users", currentUser.uid);
      const userSnap = await getDoc(userRef);

      let list = [];
      if (userSnap.exists()) {
        list = userSnap.data().customCocktails || [];
      }

      list.push(newCocktail);
      await setDoc(userRef, { customCocktails: list }, { merge: true });

      if (publicToggle) {
        await setDoc(doc(db, "publicCocktails", name), {
          name,
          price,
          alcohol,
          votes: 0
        });
      }

      document.getElementById("cName").value = "";
      document.getElementById("cPrice").value = "";
      document.getElementById("cAlc").value = "";
      document.getElementById("cPublic").checked = false;
      loadCustomCocktails();
    }

    async function loadCustomCocktails() {
      if (!currentUser) return;
      const userRef = doc(db, "users", currentUser.uid);
      const userSnap = await getDoc(userRef);
      const list = (userSnap.exists() ? userSnap.data().customCocktails : []) || [];

      const div = document.getElementById("customList");
      div.innerHTML = "";
      list.forEach(c => {
        const item = document.createElement("div");
        item.className = "cocktail-item";
        item.textContent = `${c.name} - NT$${c.price} - ${c.alcohol}% - ${c.public ? "公開" : "私人"}`;
        div.appendChild(item);
      });
    }

    function subscribeToPublicCocktails() {
      const q = query(collection(db, "publicCocktails"), orderBy("votes", "desc"));
      onSnapshot(q, snapshot => {
        const list = document.getElementById("rankingList");
        list.innerHTML = "";
        snapshot.forEach(doc => {
          const c = doc.data();
          const div = document.createElement("div");
          div.className = "cocktail-item";
          div.textContent = `${c.name} - NT$${c.price} - ${c.alcohol}% - 票數：${c.votes}`;
          if (currentUser) {
            const voteBtn = document.createElement("button");
            voteBtn.textContent = "投票";
            voteBtn.onclick = async () => {
              const voteDoc = doc(db, "votes", `${currentUser.uid}_${c.name}`);
              const voteSnap = await getDoc(voteDoc);
              if (!voteSnap.exists()) {
                await setDoc(voteDoc, { voted: true });
                await updateDoc(doc.ref, { votes: increment(1) });
              } else {
                alert("你已經投過這杯了！");
              }
            };
            div.appendChild(voteBtn);
          }
          list.appendChild(div);
        });
      });
    }

    async function searchCocktails() {
      const maxPrice = Number(document.getElementById("searchPrice").value) || 2000;
      const maxAlcohol = Number(document.getElementById("searchAlcohol").value) || 100;

      const q = query(collection(db, "publicCocktails"));
      const snap = await getDocs(q);

      const resultDiv = document.getElementById("searchResults");
      resultDiv.innerHTML = "";
      snap.forEach(doc => {
        const c = doc.data();
        if (c.price <= maxPrice && c.alcohol <= maxAlcohol) {
          const div = document.createElement("div");
          div.className = "cocktail-item";
          div.textContent = `${c.name} - NT$${c.price} - ${c.alcohol}%`;
          resultDiv.appendChild(div);
        }
      });
    }

    window.saveCustomCocktail = saveCustomCocktail;
    window.searchCocktails = searchCocktails;
  </script>
</head>
<body>
  <h1>調酒master</h1>

  <p id="userInfo">尚未登入</p>
  <button id="signIn">Google 登入</button>
  <button id="signOut">登出</button>

  <h2>新增自訂調酒</h2>
  <input type="text" id="cName" placeholder="調酒名稱" required>
  <input type="number" id="cPrice" placeholder="價錢" required>
  <input type="number" id="cAlc" placeholder="酒精%" required>
  <label><input type="checkbox" id="cPublic"> 公開</label>
  <button onclick="saveCustomCocktail()">儲存</button>

  <h2>我的調酒</h2>
  <div id="customList"></div>

  <h2>調酒排行榜（公開）</h2>
  <div id="rankingList"></div>

  <h2>搜尋推薦（公開酒譜）</h2>
  <input type="number" id="searchPrice" placeholder="最大預算（預設2000）">
  <input type="number" id="searchAlcohol" placeholder="最大酒精度（預設100）">
  <button onclick="searchCocktails()">搜尋</button>
  <div id="searchResults"></div>
</body>
</html>
