<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>調酒天地</title>
  <style>
    /* 省略樣式，跟你之前給的差不多 */
    * {
      margin: 0; padding: 0; box-sizing: border-box; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }
    body { background: #f4f1ec; color: #333; }
    header { background: #ffcc00; padding: 1rem 2rem; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
    #logo { font-size: 1.8rem; font-weight: bold; }
    #user-info { display: flex; align-items: center; gap: 1rem; }
    #login-btn, #logout-btn { padding: 0.6rem 1.2rem; background: #333; color: #fff; border: none; border-radius: 5px; cursor: pointer; }
    #user-avatar { width: 40px; height: 40px; border-radius: 50%; display: none; }
    nav { display: flex; justify-content: center; background: #fff9d6; box-shadow: inset 0 -1px 0 #e0dcbf; margin-top: 1rem;}
    nav button { flex: 1; padding: 1rem; border: none; background: none; font-size: 1rem; cursor: pointer; transition: background-color 0.3s; }
    nav button:hover { background: #ffe577; }
    .section { display: none; padding: 2rem; max-width: 800px; margin: auto; }
    .active { display: block; }
    form { display: flex; flex-direction: column; gap: 1rem; }
    label { font-weight: bold; display: flex; flex-direction: column; }
    input, select, textarea, button[type="submit"] { padding: 0.5rem; font-size: 1rem; border-radius: 5px; border: 1px solid #ccc; }
    button[type="submit"] { background: #ffcc00; border: none; cursor: pointer; font-weight: bold; }
    ul { padding-left: 0; }
    ul li { list-style: none; margin-bottom: 1rem; display: flex; justify-content: space-between; align-items: center; cursor: pointer; }
    ul li span { margin-left: 1rem; }
    #price-display { font-weight: bold; margin-top: -0.5rem; margin-bottom: 1rem; }
    #detail-modal {
      position: fixed; top: 0; left: 0; width: 100vw; height: 100vh;
      background: rgba(0,0,0,0.5); display: none; justify-content: center; align-items: center;
    }
    #detail-content {
      background: white; padding: 1rem 2rem; border-radius: 8px; max-width: 400px;
    }
    #detail-close {
      margin-top: 1rem; background: #ffcc00; border: none; padding: 0.5rem 1rem; cursor: pointer; font-weight: bold;
    }
  </style>
  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore-compat.js"></script>
</head>
<body>
  <header>
    <div id="logo">調酒天地</div>
    <div id="user-info">
      <img id="user-avatar" src="" alt="頭像" />
      <button id="login-btn">登入</button>
      <button id="logout-btn" style="display:none;">登出</button>
    </div>
  </header>

  <nav>
    <button onclick="switchPage('page1')">自訂調酒</button>
    <button onclick="switchPage('page2')">搜尋推薦</button>
    <button onclick="switchPage('page3')">排行榜</button>
  </nav>

  <section id="page1" class="section active">
    <h2>自訂你的調酒</h2>
    <form id="custom-cocktail-form">
      <label>調酒名稱<input type="text" id="cocktail-name" required /></label>
      <label>內容物<input type="text" id="ingredients" required /></label>
      <label>比例（例如 2:1:1）<input type="text" id="ratio" /></label>
      <label>口感描述<textarea id="description" rows="3"></textarea></label>
      <label>價錢估計 <span id="price-display">550</span> 元
        <input type="range" id="price" min="100" max="1000" step="50" value="550" />
      </label>
      <label>是否公開<input type="checkbox" id="is-public" /></label>
      <button type="submit">儲存酒譜</button>
    </form>

    <h3>你的酒譜列表</h3>
    <ul id="user-cocktail-list"></ul>
  </section>

  <section id="page2" class="section">
    <h2>搜尋推薦調酒</h2>
    <form id="search-form">
      <label>預算（元）<input type="number" id="search-budget" min="100" step="50" /></label>
      <label>酒精濃度（%）<input type="number" id="search-alcohol" min="0" max="100" /></label>
      <button type="submit">搜尋推薦</button>
    </form>
    <ul id="recommendation-list"></ul>
  </section>

  <section id="page3" class="section">
    <h2>調酒排行榜</h2>
    <ul id="ranking-list"></ul>
  </section>

  <div id="detail-modal">
    <div id="detail-content">
      <h3 id="detail-name"></h3>
      <p><strong>內容物：</strong><span id="detail-ingredients"></span></p>
      <p><strong>比例：</strong><span id="detail-ratio"></span></p>
      <p><strong>口感描述：</strong><span id="detail-description"></span></p>
      <p><strong>價錢估計：</strong><span id="detail-price"></span> 元</p>
      <p><strong>公開：</strong><span id="detail-public"></span></p>
      <button id="detail-close">關閉</button>
    </div>
  </div>

  <script>
    // Firebase 初始化
    const firebaseConfig = {
      apiKey: "AIzaSyAb7IehvgRm-b2o_yJ3SkdQDWwjy7ugC6I",
      authDomain: "cocktail-selector-a1b46.firebaseapp.com",
      projectId: "cocktail-selector-a1b46",
      storageBucket: "cocktail-selector-a1b46.appspot.com",
      messagingSenderId: "213382733661",
      appId: "1:213382733661:web:3487fa9ebbb2e0c64652b4",
      measurementId: "G-LC2T6DR3HB"
    };
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();

    // 元素
    const loginBtn = document.getElementById('login-btn');
    const logoutBtn = document.getElementById('logout-btn');
    const userAvatar = document.getElementById('user-avatar');
    const userCocktailList = document.getElementById('user-cocktail-list');
    const rankingList = document.getElementById('ranking-list');
    const recommendationList = document.getElementById('recommendation-list');
    const priceInput = document.getElementById('price');
    const priceDisplay = document.getElementById('price-display');

    // 價錢顯示同步
    priceInput.addEventListener('input', () => {
      priceDisplay.textContent = priceInput.value;
    });

    // 登入登出功能
    loginBtn.addEventListener('click', () => {
      const provider = new firebase.auth.GoogleAuthProvider();
      auth.signInWithPopup(provider).catch(console.error);
    });

    logoutBtn.addEventListener('click', () => {
      auth.signOut().catch(console.error);
    });

    auth.onAuthStateChanged(user => {
      if (user) {
        userAvatar.src = user.photoURL || '';
        userAvatar.style.display = 'inline-block';
        loginBtn.style.display = 'none';
        logoutBtn.style.display = 'inline-block';
        loadUserCocktails(user.uid);
        loadRanking();
      } else {
        userAvatar.style.display = 'none';
        loginBtn.style.display = 'inline-block';
        logoutBtn.style.display = 'none';
        userCocktailList.innerHTML = '';
        rankingList.innerHTML = '';
        recommendationList.innerHTML = '';
      }
    });

    // 換頁
    function switchPage(id) {
      document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
      document.getElementById(id).classList.add('active');
    }

    // 儲存酒譜
    document.getElementById('custom-cocktail-form').addEventListener('submit', async e => {
      e.preventDefault();
      const user = auth.currentUser;
      if (!user) {
        alert('請先登入');
        return;
      }

      const name = document.getElementById('cocktail-name').value.trim();
      const ingredients = document.getElementById('ingredients').value.trim();
      const ratio = document.getElementById('ratio').value.trim();
      const description = document.getElementById('description').value.trim();
      const price = Number(document.getElementById('price').value);
      const isPublic = document.getElementById('is-public').checked;

      if (!name || !ingredients) {
        alert('請填寫名稱與內容物');
        return;
      }

      // 新增酒譜到 Firestore user-cocktails 集合
      const cocktailData = {
        uid: user.uid,
        name,
        ingredients,
        ratio,
        description,
        price,
        isPublic,
        votes: 0,
        createdAt: firebase.firestore.FieldValue.serverTimestamp()
      };

      try {
        const docRef = await db.collection('user-cocktails').add(cocktailData);
        // 新增後刷新列表
        await loadUserCocktails(user.uid);
        if (isPublic) {
          // 新增到排行榜 (存在一個ranking集合，doc id 用cocktail id)
          await db.collection('ranking').doc(docRef.id).set({
            name,
            votes: 0,
            price,
            ingredients,
            ratio,
            description,
            isPublic: true,
            createdAt: firebase.firestore.FieldValue.serverTimestamp()
          });
          await loadRanking();
        }
        // 清空表單
        e.target.reset();
        priceDisplay.textContent = '550';
        alert('酒譜已儲存');
      } catch (error) {
        console.error(error);
        alert('儲存失敗');
      }
    });

    // 載入使用者酒譜
    async function loadUserCocktails(uid) {
      const snapshot = await db.collection('user-cocktails')
        .where('uid', '==', uid)
        .orderBy('createdAt', 'desc')
        .get();
      userCocktailList.innerHTML = '';
      snapshot.forEach(doc => {
        const data = doc.data();
        const li = document.createElement('li');
        li.textContent = data.name;
        li.style.cursor = 'pointer';
        li.addEventListener('click', () => showDetail(data));
        userCocktailList.appendChild(li);
      });
    }

    // 載入排行榜
    async function loadRanking() {
      const snapshot = await db.collection('ranking')
        .where('isPublic', '==', true)
        .orderBy('votes', 'desc')
        .limit(30)
        .get();
      rankingList.innerHTML = '';
      snapshot.forEach(doc => {
        const data = doc.data();
        const li = document.createElement('li');
        li.textContent = `${data.name} （票數：${data.votes}）`;
        li.style.cursor = 'pointer';
        li.addEventListener('click', () => showDetail(data));
        rankingList.appendChild(li);
      });
    }

    // 搜尋推薦
    document.getElementById('search-form').addEventListener('submit', async e => {
      e.preventDefault();
      const budget = Number(document.getElementById('search-budget').value);
      const alcohol = Number(document.getElementById('search-alcohol').value);

      // 從排行榜資料搜尋公開酒譜
      const snapshot = await db.collection('ranking')
        .where('isPublic', '==', true)
        .get();

      const results = [];
      snapshot.forEach(doc => {
        const d = doc.data();
        if ((isNaN(budget) || d.price <= budget) && (isNaN(alcohol) || d.ratio.includes(`${alcohol}`))) {
          results.push(d);
        }
      });

      recommendationList.innerHTML = '';
      if (results.length === 0) {
        recommendationList.textContent = '找不到符合條件的酒譜';
      } else {
        results.forEach(d => {
          const li = document.createElement('li');
          li.textContent = d.name;
          li.style.cursor = 'pointer';
          li.addEventListener('click', () => showDetail(d));
          recommendationList.appendChild(li);
        });
      }
      switchPage('page2');
    });

    // 顯示酒譜詳細資料
    const detailModal = document.getElementById('detail-modal');
    const detailName = document.getElementById('detail-name');
    const detailIngredients = document.getElementById('detail-ingredients');
    const detailRatio = document.getElementById('detail-ratio');
    const detailDescription = document.getElementById('detail-description');
    const detailPrice = document.getElementById('detail-price');
    const detailPublic = document.getElementById('detail-public');
    const detailClose = document.getElementById('detail-close');

    function showDetail(data) {
      detailName.textContent = data.name || '';
      detailIngredients.textContent = data.ingredients || '';
      detailRatio.textContent = data.ratio || '';
      detailDescription.textContent = data.description || '';
      detailPrice.textContent = data.price || '';
      detailPublic.textContent = data.isPublic ? '是' : '否';
      detailModal.style.display = 'flex';
    }

    detailClose.addEventListener('click', () => {
      detailModal.style.display = 'none';
    });
  </script>
</body>
</html>
