<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>調酒 Master</title>
  <style>
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background-color: #f4f1ec;
      color: #333;
    }
    .section { display: none; }
    .section.active { display: block; }
    nav button.active { font-weight: bold; }
  </style>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore-compat.js"></script>
</head>
<body>
  <header>
    <div id="logo">調酒 Master</div>
    <div id="user-info">
      <img id="user-avatar" src="" alt="頭像" />
      <button id="login-btn">登入</button>
      <button id="logout-btn" style="display: none;">登出</button>
    </div>
  </header>
  <nav>
    <button class="active" onclick="switchPage('page1', this)">自訂調酒</button>
    <button onclick="switchPage('page2', this)">搜尋推薦</button>
    <button onclick="switchPage('page3', this)">排行榜</button>
  </nav>
  <section id="page1" class="section active">
    <h2>自訂你的調酒</h2>
    <form id="custom-form">
      <label>調酒名稱<input id="name" type="text" required></label>
      <label>內容物<input id="ingredients" type="text" required></label>
      <label>比例<input id="ratio" type="text"></label>
      <label>口感描述<textarea id="description" rows="3"></textarea></label>
      <label>價錢估計
        <input id="price" type="range" min="0" max="2000" step="50" value="300" oninput="priceValue.innerText = this.value + ' 元'">
        <span id="priceValue">300 元</span>
      </label>
      <label>是否公開<input id="isPublic" type="checkbox"></label>
      <button type="submit">儲存酒譜</button>
    </form>
    <ul id="custom-list"></ul>
  </section>
  <section id="page2" class="section">
    <h2>搜尋推薦調酒</h2>
    <form id="search-form">
      <label>預算（元）<input id="budget" type="number" min="0" step="50"></label>
      <label>酒精濃度（目前未使用）<input type="number" min="0" max="100"></label>
      <button type="submit">搜尋推薦</button>
    </form>
    <div id="recommendation-list"></div>
  </section>
  <section id="page3" class="section">
    <h2>調酒排行榜</h2>
    <ul id="ranking-list"></ul>
  </section>
  <script>
    const firebaseConfig = {
      apiKey: "YOUR_API_KEY",
      authDomain: "YOUR_AUTH_DOMAIN",
      projectId: "YOUR_PROJECT_ID",
      storageBucket: "YOUR_STORAGE_BUCKET",
      messagingSenderId: "YOUR_MESSAGING_SENDER_ID",
      appId: "YOUR_APP_ID"
    };
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();
    let currentUser = null;

    function switchPage(id, btn) {
      document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
      document.getElementById(id).classList.add('active');
      document.querySelectorAll('nav button').forEach(b => b.classList.remove('active'));
      btn.classList.add('active');
    }

    auth.onAuthStateChanged(user => {
      if (user) {
        currentUser = user;
        document.getElementById('user-avatar').src = user.photoURL || '';
        document.getElementById('login-btn').style.display = 'none';
        document.getElementById('logout-btn').style.display = 'inline';
        loadUserCocktails();
        listenToRanking();
      } else {
        currentUser = null;
        document.getElementById('user-avatar').src = '';
        document.getElementById('login-btn').style.display = 'inline';
        document.getElementById('logout-btn').style.display = 'none';
        document.getElementById('custom-list').innerHTML = '';
        document.getElementById('ranking-list').innerHTML = '';
      }
    });

    document.getElementById('login-btn').onclick = () => auth.signInWithPopup(new firebase.auth.GoogleAuthProvider());
    document.getElementById('logout-btn').onclick = () => auth.signOut();

    document.getElementById('custom-form').addEventListener('submit', async e => {
      e.preventDefault();
      if (!currentUser) return;
      const name = document.getElementById('name').value;
      const ingredients = document.getElementById('ingredients').value;
      const ratio = document.getElementById('ratio').value;
      const description = document.getElementById('description').value;
      const price = parseInt(document.getElementById('price').value);
      const isPublic = document.getElementById('isPublic').checked;

      const cocktail = {
        uid: currentUser.uid,
        name, ingredients, ratio, description, price,
        isPublic,
        votes: 0,
        timestamp: firebase.firestore.FieldValue.serverTimestamp()
      };

      const docRef = await db.collection('cocktails').add(cocktail);

      if (isPublic) {
        await db.collection('ranking').doc(docRef.id).set({
          name, price, votes: 0, timestamp: firebase.firestore.FieldValue.serverTimestamp()
        });
      }

      loadUserCocktails();
    });

    async function loadUserCocktails() {
      const list = document.getElementById('custom-list');
      list.innerHTML = '';
      if (!currentUser) return;
      const snapshot = await db.collection('cocktails')
        .where('uid', '==', currentUser.uid)
        .orderBy('timestamp', 'desc')
        .get();
      snapshot.forEach(doc => {
        const data = doc.data();
        const li = document.createElement('li');
        li.textContent = `${data.name} - $${data.price}`;
        list.appendChild(li);
      });
    }

    function listenToRanking() {
      const list = document.getElementById('ranking-list');
      db.collection('ranking').orderBy('votes', 'desc')
        .onSnapshot(snapshot => {
          list.innerHTML = '';
          snapshot.forEach(doc => {
            const data = doc.data();
            const li = document.createElement('li');
            li.textContent = `${data.name} - ${data.votes} 票`;
            list.appendChild(li);
          });
        });
    }
  </script>
</body>
</html>
